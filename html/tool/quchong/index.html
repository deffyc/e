<!doctype html>

<html lang="zh">
<head>
  <meta charset="utf-8">
  <title>文本工具包</title>
<script type=""></script>
<script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.3.1.slim.min.js"></script>
<script src="https://unpkg.com/papaparse@4.6.3/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jschardet/1.4.1/jschardet.min.js"></script>
<script src="https://cdn.bootcss.com/dot/2.0.0-beta.0/doT.min.js"></script>

<script src="txttool.js"></script>


  <style>
    textarea {
      width: 100%;
      word-break: break-all; //解决兼容问题
      font-family: "Lucida Console"
    }
	label{
            position: relative;
        }
        #csvfile{
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
        }
        #btn{
            margin-right: 5px;
        }
        #text{
            color: red;
        }
  </style>
</head>

<body>
	<textarea id="editor" rows="10"></textarea>
	<br/>
  
  <div id="evaluation"></div>
 <script id="arraystmpl" type="text/x-dot-template">
  {{ for(var prop in it) { }}
		{{= prop }}
		{{~it[prop] :subValue:subIndex }}
			<input type="radio" name="pastFn" value="{{=subValue.name}}"/><label for="{{=subValue.name}}">{{=subValue.label}}</label>
		
		{{~}}
		<br/>
    {{ } }}
	
	</script>
	其他:
<label for="csvfile">
        <input type="button" id="btn" value="选择cvs"><span id="cvsfiletip">cvsTojson</span>
        <input type="file" id="csvfile">
</label>
  <br/>
  日志:<br/>
  <pre id="runtime"></pre>

  <script>
	
var editor = document.getElementById("editor")
function jsonToCvs(event){
	var clipboard = event.clipboardData;
	var data = clipboard.getData('text/plain');
	cvs=Papa.unparse(data)
	editor.value = cvs;
	return "成功处理"
}
function jsonToCvs(event){
	var clipboard = event.clipboardData;
	var data = clipboard.getData('text/plain');
	cvs=Papa.unparse(data)
	editor.value = cvs;
	return "成功处理"
}

function cvsToJson(event){
	var clipboard = event.clipboardData;
	var data = clipboard.getData('text/plain');
	arr=Papa.parse(data)
	editor.value = JSON.stringify(arr);
	return "成功处理：" + arr.length + "个"
}
function jsonToTxt(event) {
	var clipboard = event.clipboardData;
	var data = clipboard.getData('text/plain');
	parseStrToJson(data).then(function(arr) {
		if (!Array.prototype.isPrototypeOf(arr)) {
			var str = "只处理json数组";
			document.getElementById("runtime").innerHTML = str;
			return
		}
		if (!Array.prototype.isPrototypeOf(arr[0])) {
			var str = "json的第一个元素必须为属性名序列数组";
			document.getElementById("runtime").innerHTML = str;
			return
		}

		keyArray = arr[0].keys()
		str = keyArray.join("\n")
		idsuffix=". "
		for (var i = 1; i < arr.length; i++) {
			str += "\n"
			for (var j = 0; j < keyArray.length; j++) {
				key = keyArray[j]
				str += (j==1?idsuffix:"\n")+(typeof(arr[i][key]) == "undefined" ? "" : arr[i][key])
				//console.log(key+":"+arr[i]);
			}
		}
		
		//返回结果
		editor.value=str
		return "成功处理：" + arr.length + "个"
		console.log("成功处理：" + arr.length + "个");
	}).catch(function(err) {
		return "错误！"
		console.log(err);
	})
	return "成功处理！"
}

function txtToJson(event) {
	var clipboard = event.clipboardData;
	var data = clipboard.getData('text/plain');
	//**/[\u4E00-\uFA29]|[\uE7C7-\uE7F3]|[a-zA-Z0-9_-]|["',，.。\/、\]\[\{\}【】\n\s！!?？——_<>%;‘’；)《（）》(&+=`“”·*#@]+/g**/
	//console.log(data)
	data=data.replace(/\r/g,'')
	withoutNo=/(.+)\n((.+\n)*)\n/g
	withId=/(([0-9]{1,})|no). (.+)\n((.+\n)*)/g
	idFlag=data.substring(0,4)=="no. "?true:false
	re=idFlag?withNo:withoutNo
	arr=[]
	if(idFlag){
		while(r = re.exec(data)) {  
		  arr.push(r[1]+"\n\n"+r[3] + "\n\n" + r[4]);  
		} 
	}else{
		while(r = re.exec(data)) {  
		  arr.push(arr.length+"\n\n"+r[1] + "\n\n" + r[2]);  
		}
		arr[0]=arr[0].replace("0\n\n","no\n\n")
	}
	
	console.log(arr)
	jsonObjs=$.rowsToJson(arr,function(nameRow){
		return nameRow.split("\n\n").trim()
	},function(dataRow){
		return dataRow.split("\n\n")
	
	})
	editor.value = JSON.stringify(jsonObjs);
	//返回结果
	return "no.开头带编号，第一个对象为属性名数组。对象之间两个\\n换行符，对象第一行为标题。共：" + (jsonObjs.length) + "对象。";
}

function quchong(event) {
	var clipboard = event.clipboardData;
	var data = clipboard.getData('text/plain');
	arr = data.split('\n');
	uniqueArr = arr.unique();
	editor.value = uniqueArr.join('\n');
	//返回函数执行需要时间
	return "粘贴前：" + arr.length + "行,去重后：" + uniqueArr.length + "行。去重行数：" + (arr.length - uniqueArr.length) + "行。";
}

function getPastFnStr(disabled = "true") {
	if ("true" != disabled) disabled = ""
	var item = null;
	var obj = document.getElementsByName("pastFn")
	for (var i = 0; i < obj.length; i++) { //遍历Radio 
		if (obj[i].checked) {
			item = obj[i].value;
		} 
		obj[i].disabled = disabled
	}
	return item;
}
editor.addEventListener('paste', function(e) {
	event.preventDefault();
	funName = getPastFnStr()
	var start = new Date().getTime(); //起始时间
	console.log('开始执行：' + funName)
	log = window[funName](e)
	getPastFnStr("")
	var end = new Date().getTime(); //接受时间
	console.log('执行结束：' + funName + '耗时：' + (end - start) + "ms")
	document.getElementById("runtime").innerHTML = log;
}, false);
tipMap={}
init()

function init(){
	typeArr=["选项","文本","转换","其他"]
	radioArr=[{"type":"文本","name":"quchong","label":"去重","tip":""},
	{"type":"转换","name":"txtToJson","label":"txtToJson","tip":"pattern:(.+)\\n((.+\\n)*):\npString:(.+)\\\\n((.+\\\\n)*)\ncontent:(title)\\n((content)*)\n-----\ntitle1\ncontent1\n\ntitle2\ncontent2\n---\npattern:([0-9]{1,}). (.+)\\n((.+\\n)*)\npString:([0-9]{1,})\. (.+)\\\\n((.+\\\\n)*)\ncontent:(no)\. (title)\\n((content)*)\n---\nno1. title1\ncontent1\n\nno2. title2\ncontent2\n\n"},
	{"type":"转换","name":"jsonToTxt","label":"jsonToTxt","tip":"jsonToTxt"},
	{"type":"转换","name":"cvsToJson","label":"cvsToJson","tip":"cvsToJson"},
	{"type":"转换","name":"jsonToCvs","label":"jsonToCvs","tip":"jsonToCvs"}]
	radioObjs={}
	for(var i=0;i<typeArr.length;i++){
		radioObjs[typeArr[i]]=[]
		for(var j=radioArr.length-1;j>=0;j--){
			if(radioArr[j].type==typeArr[i]){
			radioObjs[typeArr[i]].push(radioArr[j])
			tipMap[radioArr[j]["name"]]=radioArr[j]["tip"]
			radioArr.splice(j,1)
			}
		}
	}
	console.log(radioObjs)
	var evalText = doT.template($("#arraystmpl").text());
	$("#evaluation").html(evalText(radioObjs));
	lastEle=$('input[type=radio][name=pastFn]:last')
	lastEle.click()
	$("#runtime").text(tipMap[lastEle.val()])
}


$('input[type=radio][name=pastFn]').change(function() {
    $("#runtime").text(tipMap[this.value])
});
function parseStrToJson(str) {
	var p = new Promise(function(resolve, reject) {
		var cc = JSON.parse(str);
		resolve(cc);
	});
	return p;
}
$("#csvfile").change(function(){
		getPastFnStr()
		$("#cvsfiletip").html($(this).val());
		$(this).csv2arr(function(res){
			jsonObjs=$.rowsToJson(res,function(nameRow){
				return nameRow
			},function(dataRow){
				return dataRow
			
			})
			editor.value=JSON.stringify(jsonObjs);
			console.log( res );
			getPastFnStr('')
		});
});
  </script>
</body>
</html>
