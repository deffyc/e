<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<script type="text/javascript" src="https://vuejs.org/js/vue.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/axios@0.12.0/dist/axios.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/lodash@4.13.1/lodash.min.js"></script>
		<script type="text/javascript" src="https://e.ccsyue.com/tool/msg/js/SHA1.js"></script>
		<style>
			textarea {
				width: 100%;
				word-break: break-all; //解决兼容问题
				font-family: "Lucida Console"
			}
		</style>
	</head>
	<body>
		<div id="editor">
			<textarea rows="10" v-model="jsonStr" @paste="solveIt" placeholder="pasteJson"></textarea>
			<span width="100%">{{ percent }}</span>
		</div>

	</body>
	<script>
		var AppId = "";
		var AppKey = "";
		var clazz = ""
	
		function getAppKey() {
			var now = Date.now();
			var appKey = SHA1(AppId + "UZ" + AppKey + "UZ" + now) + "." + now;
			return {
				"X-APICloud-AppId": AppId,
				"X-APICloud-AppKey": appKey
			}
		}
		var vm = new Vue({
			el: '#editor',
			data: {
				jsonStr: '',
				percent: ''
			},
			methods: {
				solveIt: function(event) {
					var clipboard = event.clipboardData;
					var data = clipboard.getData('text/plain').replace(/\r/g, '\n');
					var arr = JSON.parse(data)
					requests = []
					_.forEach(arr, function(value, index, collection) { //这里规定的就是第一个参数返回的是value值，第二个参数是下标index
						requests.push({
							"method": "POST",
							"path": "/mcm/api/" + clazz,
							"body": value
						})
					});
					chunks = _.chunk(requests, 500); //每一份50个
					process(chunks, 0);
				},
			}
		})
		//处理chunks，无限递归
		function process(chunks, index) {
			//找到需要被处理的chunk
			var chunk = chunks[index];
			//判断chunk是否为undefined
			if (_.isUndefined(chunk)) {
				return;
			}
			axios.post("https://d.apicloud.com/mcm/api/batch",{"requests": chunk},{
					"cache": false,
					"headers": getAppKey(),
				}).then(function(response) {
					_.defer(_.partial(process, chunks, ++index));
					vm.percent = parseInt((index + 1) *100/ chunks.length) + '%'
				})
				.catch(function(error) {
					//_.defer(_.partial(process, chunks, index));
					console.log("insert error:" + error)
				})
	
		}
	</script>
</html>
